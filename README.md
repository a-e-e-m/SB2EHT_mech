# SB2EHT_mech

## Description
This repository contains the code and data to reproduce the analysis in the research article "Integrating data from across insecticide resistance bioassay types using a mechanistic model incorporating mosquito genetic variation and behaviour" (full reference below).

## Reference
> **Inferring a novel insecticide resistance metric and exposure variability in mosquito bioassays across Africa**
> Adrian Denz, Mara D. Kont, Antoine Sanou, Thomas S. Churcher, Ben Lambert; 
> bioRxiv 2024.03.09.584248; doi: https://doi.org/10.1101/2024.03.09.584248 

## Author Information
Name: Adrian Denz

ORCID: 0000-0002-6935-9113

Email: adi@adriandenz.com 

## Access information
The code contained in this repository is released under the MIT license, see the `LICENCE` file.
This repository contains data from as series of studies, as listed in Tables 1 and S1 of the research article cited under [Reference](#Reference), which are publicly available or which the corresponding authors made available to us. For access to any data contained in this repository please consult the corresponding original publications referenced in the research article cited under [Reference](#Reference). 

## Citation
If you use this code, please cite:
> **Adrian Denz, SB2EHT_mech, 2025.**  
> DOI: [Zenodo DOI]  
> And include the full reference to the research article cited under [Reference](#Reference).

## Funding
Adrian Denz was funded by the Swiss National Science Foundation (SNSF) [grant numbers 203017, 225815].

## Repository Contents
List the main files and their purpose:
- `data/` → Contains logs on data processing and files to define the mortality outcome time points.
- `src/stan` → Contains Stan files for each model.
- `src/R` → Contains scripts and functions to perform inference for each model with an automated workflow.
- `fitting/` → Will contain a folder for each model run generated by the automated inference worklflow.
- `fitting/data_onlyIDSB_noEHT` → Contains processed SB only data and references to original studies.
- `fitting/data_allSB_allEHT` → Contains processed SB and EHT data and references to original studies.
- `src/R/mech_model_specific` → Contains scripts to generate the figures contained in the research article cited under `Reference'.
- `plots_mechmodel_article/` → Will contain the main figures being generated.
- `plots_mechmodel_article_SI/` → Will contain the SI figures being generated.
- `tables_mechmodel_article_SI/` → Will contain the SI tables being generated.
- `models2run.csv` → Table with parameters for each model run with the automated inference workflow.
- `README.md` → This file
- `LICENSE` → Licensing information

## Getting Started

Guide to reproduce the analysis for the research article cited under [Reference](#Reference). Please consult the latter for specific terms and abbreviations used here.

### Prerequisites

To run the analysis you need to have R installed on your system. All code was tested for R version 4.4.0 "Puppy Cup". Code was developed using Rstudio, which is however not strictly necessary to reproduce the analysis. 

The following R packages are required to run the analysis and produce all Figures and Tables:
readxl, dplyr, haven, lubridate, reshape2, tidyverse, ggplot2, HDInterval, plyr, rstan, loo, parallel, data.table, patchwork, RColorBrewer, scales, stringr, tidyr, ggh4x, grid, lemon, ellipse, emdbook, figpatch, latex2exp, rlang, ggdist, ggnewscale, tidybayes, ggrepel, MASS, viridisLite, gt, webshot2, bayesplot, posterior, readr, tibble

For the list of packages required to run analysis including processing raw data, see the file `src/R/packages_cluster.R`

### Installation

To copy the code and data to your system, clone this repository to your file system.


### Usage

#### Processing Raw Data

Readily processed SB and EHT data sets, including matching of assay pairs, used to fit the SB only and the joint SB and EHT models are contained in `fitting/data_onlyIDSB_noEHT` and `fitting/data_allSB_allEHT`, respectively. Specifically, `B.rds` holds the SB data as read in by Stan, `B_all.rds` holds the same data with additional variables for plotting, while`H.rds` and `H_all.rds` hold the analogous EHT data. For references to the original studies that collected the data, see the file `data_summary.csv` using the `Trial_code` ID. Note that for historical reasons, the assay pair ID used in the article is a permutation of the IDs in the variables `T_b` and `T_h` contained in `B.rds` and `H.rds`, respectively.

The scripts and functions that were used to generate these data sets from the raw data are contained in `src/R` for illustration; the raw data files are however not included in this repository as they contain further data provided to us under restricted data sharing conditions. 

#### Inference

To run the automated workflow for inference with Stan for one of the model runs listed in `models2run.csv`, run the command `Rscript src/R/master_script_fitting.R j` after replacing `j` with the corresponding row ID in `models2run.csv`. The workflow will create a folder in `fitting/` for the model run, call scripts and functions to invoke the Stan sampler, and safe files containing the stan fit objects, inference diagnostics as well as some plots in the created folder. Thus, for the SB_only model run `Rscript src/R/master_script_fitting.R 3` and for the joint SB and EHT model run `Rscript src/R/master_script_fitting.R 4`. Alternatively, using e.g. RStudio, you can follow the instructions in `src/R/master_script_fitting.R` for running the inference for a given model run.

It may be required to increase the sample size or to alter the tuning parameters of Stan's NUTS sampler to achieve MCMC convergence, as this can vary stochastically from run to run. To do so, one can alter in `models2run.csv` either the entries in the columns `warmup` and `iter` (an integer value) or in the column `control list name` (`adapt_delta95`, `adapt_delta95_plus` or `adapt_delta98_plus`, see `src/R/stan_control_list/`).

#### Figures and Tables

To generate the figures and Tables contained in the research article cited under [Reference](#Reference), source all scripts starting with the string `publicationplot` or `publicationtables` in the folder `src/R/mech_model_specific`. Note that this requires both the SB only and the joint model (see `models2run.csv` rows with `Row ID` 3 and 4, respectively) were fitted (see [Inference](#Inference) above). Figures are saved in PNG format in the folders `plots_mechmodel_article/' and `plots_mechmodel_article_SI/'; tables are saved in html format in the folder `tables_mechmodel_article_SI`. 


### Methodological information 

The mechanistic models implemented in Stan are explained and discussed in the research article cited under [Reference](#Reference).




